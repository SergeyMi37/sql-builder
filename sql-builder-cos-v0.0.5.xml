<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25" zv="Cache for Windows (x86-32) 2016.1.2 (Build 206U)" ts="2017-01-24 16:47:53">
<Class name="gen.SQLBuilder">
<Super>%RegisteredObject</Super>
<TimeChanged>64307,60338.447493</TimeChanged>
<TimeCreated>64174,51856.58627</TimeCreated>

<Parameter name="Version">
<Default>0.0.5</Default>
</Parameter>

<Property name="Select">
<Type>%String</Type>
<Internal>1</Internal>
<InitialExpression>"*"</InitialExpression>
</Property>

<Property name="Update">
<Type>%String</Type>
<Internal>1</Internal>
</Property>

<Property name="From">
<Type>%String</Type>
<Internal>1</Internal>
</Property>

<Property name="Where">
<Type>%String</Type>
<Internal>1</Internal>
</Property>

<Property name="GroupBy">
<Type>%String</Type>
<Internal>1</Internal>
</Property>

<Property name="OrderBy">
<Type>%String</Type>
<Internal>1</Internal>
</Property>

<Property name="Fields">
<Type>%ArrayOfDataTypes</Type>
<Private>1</Private>
</Property>

<Property name="Columns">
<Type>%ListOfDataTypes</Type>
<Private>1</Private>
</Property>

<Property name="SubQueryAlias">
<Type>%String</Type>
</Property>

<Property name="Statement">
<Type>%Integer</Type>
<Internal>1</Internal>
<InitialExpression>1</InitialExpression>
<Parameter name="DISPLAYLIST" value=",Select,Update,Insert,Delete"/>
<Parameter name="VALUELIST" value=",1,2,3,4"/>
</Property>

<Method name="Delete">
<FormalSpec>params:%String=""</FormalSpec>
<ReturnType>gen.SQLBuilder</ReturnType>
<Implementation><![CDATA[
	Set ..Select = ""
	Set ..Update = ""
	Set ..Statement = 4
	Quit $This
]]></Implementation>
</Method>

<Method name="Select">
<FormalSpec>params:%String=""</FormalSpec>
<ReturnType>gen.SQLBuilder</ReturnType>
<Implementation><![CDATA[
	If params'="" {
		Set auxList = $ListFromString(params,",")
		Set select = ""
		For k=1:1:$ListLength(auxList) {
			Set:$List(auxList,k)'="" $List(select,*+1) = $List(auxList,k)
		}
		Set ..Select = $ListToString(select,",")
	}
	Set ..Statement = 1
	Quit $This
]]></Implementation>
</Method>

<Method name="Update">
<ReturnType>gen.SQLBuilder</ReturnType>
<Implementation><![CDATA[
	Set ..Select = ""
	Set ..Statement = 2
	Quit $This
]]></Implementation>
</Method>

<Method name="Insert">
<ReturnType>gen.SQLBuilder</ReturnType>
<Implementation><![CDATA[
	Set ..Select = ""
	Set ..Statement = 3
	Quit $This
]]></Implementation>
</Method>

<Method name="Set">
<FormalSpec>pField:%String,pValue:%String="",pAllowNull:%Boolean=0</FormalSpec>
<ReturnType>gen.SQLBuilder</ReturnType>
<Implementation><![CDATA[
	Do:((pValue'="")||(pAllowNull=1)) ..AddField(pField, pValue)
	Quit $This
]]></Implementation>
</Method>

<Method name="Column">
<FormalSpec>pField,pAlias:%String=""</FormalSpec>
<ReturnType>gen.SQLBuilder</ReturnType>
<Implementation><![CDATA[
	Set:($IsObject(pField)&&($ClassName(pField)=$ClassName($This))) pField = "("_
		pField.GetSQL() _ ")" _ 
		$Case(pField.SubQueryAlias,"":"",:" As " _ pField.SubQueryAlias)
		
	Set:pAlias'="" pField = pField _ " As " _ pAlias
	Do ..Columns.Insert(pField)
	Quit $This
]]></Implementation>
</Method>

<Method name="As">
<FormalSpec>pAlias:%String</FormalSpec>
<ReturnType>gen.SQLBuilder</ReturnType>
<Implementation><![CDATA[
	Set ..SubQueryAlias = pAlias
	Q $This
]]></Implementation>
</Method>

<Method name="From">
<FormalSpec>pFrom:%String</FormalSpec>
<ReturnType>gen.SQLBuilder</ReturnType>
<Implementation><![CDATA[
	Set ..From = pFrom
	Quit $This
]]></Implementation>
</Method>

<Method name="Where">
<FormalSpec>args...</FormalSpec>
<ReturnType>gen.SQLBuilder</ReturnType>
<Implementation><![CDATA[
	Set result = ..GetStringPrepare(args...)
	Quit:result="" $This
	Quit ..WhereInterno(result)
]]></Implementation>
</Method>

<Method name="WhereInterno">
<Internal>1</Internal>
<FormalSpec>pWhere:%String,pAndOr=0</FormalSpec>
<Private>1</Private>
<ReturnType>gen.SQLBuilder</ReturnType>
<Implementation><![CDATA[
	If ..Where=""{
		Set ..Where = pWhere
	} Else {
		Set:..Where'="" ..Where = ..Where _ $Case(pAndOr,0:" AND ",1:" OR ") _ pWhere
	}
	Quit $This
]]></Implementation>
</Method>

<Method name="Or">
<FormalSpec>args...</FormalSpec>
<ReturnType>gen.SQLBuilder</ReturnType>
<Implementation><![CDATA[
	Set result = ..GetStringPrepare(args...)
	Quit:result="" $This
	Quit ..WhereInterno(result,1)
]]></Implementation>
</Method>

<Method name="And">
<FormalSpec>args...</FormalSpec>
<ReturnType>gen.SQLBuilder</ReturnType>
<Implementation><![CDATA[
	Set result = ..GetStringPrepare(args...)
	Quit:result="" $This
	Quit ..WhereInterno(result)
]]></Implementation>
</Method>

<Method name="Between">
<FormalSpec>pProp,pInferior,pSuperior,pType=0</FormalSpec>
<ReturnType>gen.SQLBuilder</ReturnType>
<Implementation><![CDATA[
	Set sql = "(" _ pProp _ " BETWEEN " _ pInferior _ " AND " _ pSuperior _ ")"
	Quit ..WhereInterno(sql)
]]></Implementation>
</Method>

<Method name="Join">
<FormalSpec>table:%String,prop:%String</FormalSpec>
<ReturnType>gen.SQLBuilder</ReturnType>
</Method>

<Method name="GetStringPrepare">
<ClassMethod>1</ClassMethod>
<FormalSpec>args...</FormalSpec>
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	Set output = ""
	Try {
		Set output = $Get(args(1))
		
		Set k = 2, sanitize = "'"
		
		Set:$Find($ZConvert(output,"U"),"LIKE")>0 sanitize = "#"
		Set matcher = $ListFromString(output,"?"), output = ""
		
	    For i=1:1:$ListLength(matcher) {
		    Set got = "", arg = $Get(args(k))
		    
		    If $IsObject(arg){
		    	Set:$ClassName(arg)=$ClassName($This) got = "(" _ arg.GetSQL()_")"
		    } Else {
		    	Set:arg'="" got = sanitize_$Replace(arg,"'","")_sanitize
		    }
		    
		    
		    Set output = output _ $List(matcher,i) _ got
	        Set k = $Increment(k)
	    }
	    
	    Set:$Find(output,"''")>0 output = ""
	    Set:$Find(output,"##")>0 output = ""
	    Set:output'="" output = $Replace(output,"#","")
		
	} Catch {
		Set output = ""
	}
	Quit output
]]></Implementation>
</Method>

<Method name="Order">
<FormalSpec>pOrderBy:%String</FormalSpec>
<ReturnType>gen.SQLBuilder</ReturnType>
<Implementation><![CDATA[
	Set ..OrderBy = ""
	Quit ..OrderBy(pOrderBy)
]]></Implementation>
</Method>

<Method name="OrderBy">
<FormalSpec>pOrderBy:%String</FormalSpec>
<ReturnType>gen.SQLBuilder</ReturnType>
<Implementation><![CDATA[
	Set:..OrderBy'="" ..OrderBy = ..OrderBy _ "," _ pOrderBy
	Set:..OrderBy="" ..OrderBy = pOrderBy
	Quit $This
]]></Implementation>
</Method>

<Method name="GroupBy">
<FormalSpec>pGroupBy:%String</FormalSpec>
<ReturnType>gen.SQLBuilder</ReturnType>
<Implementation><![CDATA[
	Set:..GroupBy'="" ..GroupBy = ..GroupBy _ "," _ pGroupBy
	Set:..GroupBy="" ..GroupBy = pGroupBy
	Quit $This
]]></Implementation>
</Method>

<Method name="AndIf">
<FormalSpec>pCondition,args...</FormalSpec>
<ReturnType>gen.SQLBuilder</ReturnType>
<Implementation><![CDATA[
	Quit:pCondition ..And(args...)
	Quit $This
]]></Implementation>
</Method>

<Method name="OrIf">
<FormalSpec>pCondition,args...</FormalSpec>
<ReturnType>gen.SQLBuilder</ReturnType>
<Implementation><![CDATA[
	Quit:pCondition ..Or(args...)
	Quit $This
]]></Implementation>
</Method>

<Method name="WhereIf">
<FormalSpec>pCondition,args...</FormalSpec>
<ReturnType>gen.SQLBuilder</ReturnType>
<Implementation><![CDATA[
	Quit:pCondition ..Where(args...)
	Quit $This
]]></Implementation>
</Method>

<Method name="GetSQL">
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	Quit:..Statement=1 ..GetSelectStatement()
	Quit:..Statement=2 ..GetUpdateStatement()
	Quit:..Statement=3 ..GetInsertStatement()
	Quit:..Statement=4 ..GetDeleteStatement()
]]></Implementation>
</Method>

<Method name="GetSelectStatement">
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	Set select = ""
	Set:..Select'="*" $List(select, *+1) = ..Select
	For k=1:1:..Columns.Count() {
		Set $List(select, *+1)=..Columns.GetAt(k)
	}
	
	Set sql = "Select " _ $Case($ListLength(select),0: ..Select,:$ListToString(select,","))
	
	Set sql = sql _ " From " _ ..From
	Set:..Where'="" sql = sql _ " Where " _ ..Where
	Set:..GroupBy'="" sql = sql _ " Group By " _ ..GroupBy
	Set:..OrderBy'="" sql = sql _ " Order By " _ ..OrderBy
	Quit sql
]]></Implementation>
</Method>

<Method name="GetDeleteStatement">
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	Set sql = "Delete "
	Set sql = sql _ " From " _ ..From
	Set:..Where'="" sql = sql _ " Where " _ ..Where
	Quit sql
]]></Implementation>
</Method>

<Method name="GetUpdateStatement">
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	Set sql = "Update " _ ..From 
	Do ..AbstractGetFieldsBlock(.setFieldsStatement)
	Set sql = sql _ setFieldsStatement
	Set:..Where'="" sql = sql _ " Where " _ ..Where
	Quit sql
]]></Implementation>
</Method>

<Method name="GetInsertStatement">
<Private>1</Private>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	Set sql = "Insert INTO " _ ..From _ " "
	Do ..AbstractGetFieldsBlock(.setFieldsStatement)
	Set sql = sql _ setFieldsStatement
	W sql,!
	Quit sql
]]></Implementation>
</Method>

<Method name="Execute">
<FormalSpec>*tSC:%Status="",Args...</FormalSpec>
<ReturnType>%ResultSet</ReturnType>
<Implementation><![CDATA[
	Set tSC = $$$OK, tRS = ""
	Try {
		Set statement = ##class(%SQL.Statement).%New()
		$$$THROWONERROR(tSC, statement.%Prepare(..GetSQL()))
		
		Set tRS = statement.%Execute(Args...)
	}
	Catch tException {
		Set:$$$ISOK(tSC) tSC = tException.AsStatus()
	}
	Quit tRS
]]></Implementation>
</Method>

<Method name="%OnNew">
<FormalSpec>table:%String=""</FormalSpec>
<Private>1</Private>
<ReturnType>%Status</ReturnType>
<ServerOnly>1</ServerOnly>
<Implementation><![CDATA[
	Set ..From = table
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="AddField">
<Description><![CDATA[
This method is just to insert on %ArrayOfDataTypes property using Key and Value. <br>
'Cos cachÃ© set array inverse (Value, Key)...]]></Description>
<FormalSpec>pField,pValue=""</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Set tSC = $$$OK
	Try {
		$$$THROWONERROR(tSC, ..Fields.SetAt(pValue, pField))
	} Catch tException {
		Set:$$$ISOK(tSC) tSC = tException.AsStatus()
	}
	Quit tSC
]]></Implementation>
</Method>

<Method name="AbstractGetFieldsBlock">
<FormalSpec>*pQueryBlock</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	Set tSC = $$$OK
	Try {
		Set into = "", field = ..Fields.Next("")
		
		While field'="" {
			Set updateAttr = " = ?"
			Set:..Fields.GetAt(field)="" updateAttr = ""
			Set:..Statement=2 $List(into, *+1) = ..GetStringPrepare(field _ updateAttr, ..Fields.GetAt(field)) //Update
			Kill updateAttr
			
			If ..Statement=3 { // Insert
				Set $List(into, *+1) = field 
				Set $List(values, *+1) = ..GetStringPrepare("?",..Fields.GetAt(field))
			}

			Set field = ..Fields.Next(field)
		}
		
		Set:..Statement=2 pQueryBlock = " SET " _ $ListToString(into,", ")
		Set:..Statement=3 pQueryBlock = " (" _ $ListToString(into,", ")_") VALUES ("_$LTS(values,", ")_" )"

	} Catch tException {
		Set:$$$ISOK(tSC) tSC = tException.AsStatus()
	}
	Quit tSC
]]></Implementation>
</Method>
</Class>
</Export>
